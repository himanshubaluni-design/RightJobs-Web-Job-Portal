<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - RightJobs</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="signup-styles.css">
</head>

<body>
  <nav class="nav">
    <a href="index.html" class="nav-logo">
      <div class="nav-logo-icon"><svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="8" stroke="white" stroke-width="2" fill="none" />
          <path d="M8 12L11 15L16 9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg></div>
      <span class="nav-logo-text"><span class="nav-logo-right">Right</span><span
          class="nav-logo-jobs">Jobs</span></span>
    </a>
    <div class="nav-right">
      <p class="login-link">Already have an account? <span onclick="window.location.href='login.html'">Login</span></p>
    </div>
  </nav>
  <div class="signup-container">
    <div class="signup-wrapper">
      <div class="signup-left">
        <div class="signup-left-content">
          <h2>Create Your Profile</h2>
          <p>Complete your profile in 3 easy steps and get discovered by top employers.</p>
          <div class="progress-steps" id="progressSteps"></div>
          <div class="stats-row">
            <div class="stat-item">
              <h3>50L+</h3>
              <p>Active Jobs</p>
            </div>
            <div class="stat-item">
              <h3>2L+</h3>
              <p>Hired</p>
            </div>
            <div class="stat-item">
              <h3>10K+</h3>
              <p>Companies</p>
            </div>
          </div>
        </div>
      </div>
      <div class="signup-right">
        <form class="signup-form" id="signupForm"></form>
      </div>
    </div>
  </div>

  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Initialize Supabase client properly
    const { createClient } = supabase;
    const sb = createClient(
      'https://rjjfjzgvthhqeokfrrwd.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqamZqemd2dGhocWVva2ZycndkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2Nzk0NzcsImV4cCI6MjA4NTI1NTQ3N30.xWlBJ5_wyI3oaVYDtpjmAF5aY-q1wpa_Uo6mFA45-ao'
    );

    console.log('Supabase initialized:', sb);

    // Global variables
    let currentStep = 1, phoneNumber = '', skills = [], isExperienced = true, resumeFile = null, profilePicFile = null;
    let emailValid = false, passwordValid = false;

    // Initialize form on page load
    document.addEventListener('DOMContentLoaded', function () {
      initProgressSteps();
      initFormSteps();
      initOtpHandlers();
      initStep2Handlers();
      initStep3Handlers();
    });

    function initProgressSteps() {
      const container = document.getElementById('progressSteps');
      container.innerHTML = `
        <div class="progress-step active" data-step="1"><div class="progress-step-indicator"><div class="progress-step-number">1</div><div class="progress-step-line"></div></div><div class="progress-step-content"><div class="progress-step-title">Primary Identity</div><div class="progress-step-desc">Mobile, Email & Location</div></div></div>
        <div class="progress-step" data-step="2"><div class="progress-step-indicator"><div class="progress-step-number">2</div><div class="progress-step-line"></div></div><div class="progress-step-content"><div class="progress-step-title">Professional Info</div><div class="progress-step-desc">Experience, Skills & Resume</div></div></div>
        <div class="progress-step" data-step="3"><div class="progress-step-indicator"><div class="progress-step-number">3</div><div class="progress-step-line"></div></div><div class="progress-step-content"><div class="progress-step-title">Education & Preferences</div><div class="progress-step-desc">Qualifications & Salary</div></div></div>`;
    }

    function initFormSteps() {
      const form = document.getElementById('signupForm');
      form.innerHTML = getStep1HTML() + getStep2HTML() + getStep3HTML() + getSuccessHTML();
    }

    function goToStep(step) {
      document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
      document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
      document.querySelectorAll('.progress-step').forEach((ps, i) => {
        ps.classList.remove('active', 'completed');
        if (i + 1 < step) ps.classList.add('completed');
        else if (i + 1 === step) ps.classList.add('active');
      });
      currentStep = step;
      document.querySelector('.signup-right').scrollTop = 0;
    }

    function getStep1HTML() {
      return `<div class="form-step active" data-step="1">
        <div class="form-header"><h1>Primary Identity</h1><p>Let's start with your basic information</p></div>
        <div class="form-section" id="mobileSection">
          <div class="form-group"><label>Mobile Number <span class="required">*</span></label>
            <div class="phone-input-group"><div class="country-code">+91</div><div class="input-wrapper no-icon"><input type="tel" id="phoneNumber" placeholder="Enter 10-digit mobile number" maxlength="10" required></div></div>
            <p class="helper-text">We'll send an OTP to verify your number</p>
            <div class="error-message" id="phoneError" style="display:none"><i class="fas fa-exclamation-circle"></i><span>Please enter a valid 10-digit mobile number</span></div>
          </div>
          <button type="button" class="btn btn-primary btn-block" id="sendOtpBtn">Send OTP <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
        </div>
        <div class="form-section" id="otpSection" style="display:none">
          <div class="form-group"><label>Enter OTP</label>
            <div class="otp-container"><input type="text" class="otp-input" maxlength="1" data-index="0" inputmode="numeric"><input type="text" class="otp-input" maxlength="1" data-index="1" inputmode="numeric"><input type="text" class="otp-input" maxlength="1" data-index="2" inputmode="numeric"><input type="text" class="otp-input" maxlength="1" data-index="3" inputmode="numeric"><input type="text" class="otp-input" maxlength="1" data-index="4" inputmode="numeric"><input type="text" class="otp-input" maxlength="1" data-index="5" inputmode="numeric"></div>
            <div class="otp-info"><p>OTP sent to <span class="phone-display" id="phoneDisplay">+91 98765 43210</span></p>
              <div class="demo-otp-box"><p class="demo-label">Demo OTP (for testing)</p><div class="demo-otp-code">123456</div><button type="button" class="auto-fill-btn" id="autoFillOtp">Auto-fill OTP</button></div>
              <button type="button" class="resend-link" id="resendOtp" disabled><i class="fas fa-redo"></i> Resend OTP <span id="resendTimer">(30s)</span></button>
            </div>
            <div class="error-message" id="otpError" style="display:none"><i class="fas fa-exclamation-circle"></i><span>Invalid OTP. Please try again.</span></div>
          </div>
          <button type="button" class="btn btn-primary btn-block" id="verifyOtpBtn">Verify OTP <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
        </div>
        <div class="form-section" id="detailsSection" style="display:none">
          <div class="form-row">
            <div class="form-group"><label>Full Name <span class="required">*</span></label><div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="text" id="fullName" placeholder="Enter your full name" required></div></div>
            <div class="form-group">
              <label>Email Address <span class="required">*</span></label>
              <div class="input-wrapper">
                <i class="fas fa-envelope input-icon"></i>
                <input type="email" id="email" placeholder="Enter your email" required>
              </div>
              <div class="error-message" id="emailError" style="display:none"><i class="fas fa-exclamation-circle"></i><span>Please enter a valid email address</span></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>City <span class="required">*</span></label><div class="input-wrapper select-wrapper"><i class="fas fa-map-marker-alt input-icon"></i><select id="city" required><option value="" disabled selected>Select city</option><optgroup label="Tier 1"><option value="mumbai">Mumbai</option><option value="delhi">Delhi NCR</option><option value="bangalore">Bangalore</option><option value="hyderabad">Hyderabad</option><option value="chennai">Chennai</option><option value="kolkata">Kolkata</option><option value="pune">Pune</option></optgroup><optgroup label="Tier 2"><option value="ahmedabad">Ahmedabad</option><option value="jaipur">Jaipur</option><option value="lucknow">Lucknow</option><option value="chandigarh">Chandigarh</option><option value="indore">Indore</option><option value="surat">Surat</option></optgroup><option value="other">Other</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div>
            <div class="form-group"><label>State <span class="required">*</span></label><div class="input-wrapper select-wrapper"><i class="fas fa-map input-icon"></i><select id="state" required><option value="" disabled selected>Select state</option><option value="maharashtra">Maharashtra</option><option value="delhi">Delhi</option><option value="karnataka">Karnataka</option><option value="telangana">Telangana</option><option value="tamil-nadu">Tamil Nadu</option><option value="west-bengal">West Bengal</option><option value="gujarat">Gujarat</option><option value="rajasthan">Rajasthan</option><option value="uttar-pradesh">Uttar Pradesh</option><option value="other">Other</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div>
          </div>
          <div class="form-group">
            <label>Create Password <span class="required">*</span></label>
            <div class="input-wrapper password-wrapper">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="password" placeholder="Create a strong password" minlength="6" required>
              <button type="button" class="password-toggle" id="togglePassword"><i class="fas fa-eye"></i></button>
            </div>
            <p class="helper-text">Minimum 6 characters</p>
            <div class="error-message" id="passwordError" style="display:none"><i class="fas fa-exclamation-circle"></i><span>Password must be at least 6 characters</span></div>
          </div>
          <div class="checkbox-group"><input type="checkbox" id="termsCheck" required><label for="termsCheck">I agree to the <a href="/terms">Terms of Service</a> and <a href="/privacy">Privacy Policy</a></label></div>
          <div class="form-actions"><button type="button" class="btn btn-primary btn-block" id="step1NextBtn">Continue to Professional Info <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button></div>
        </div>
      </div>`;
    }

    function getStep2HTML() {
      return `<div class="form-step" data-step="2">
        <div class="form-header"><h1>Professional Information</h1><p>Tell us about your work experience and skills</p></div>
        <div class="form-group"><label>Work Status <span class="required">*</span></label><div class="toggle-group"><button type="button" class="toggle-option active" data-value="experienced">Experienced</button><button type="button" class="toggle-option" data-value="fresher">Fresher</button></div></div>
        <div id="experienceSection">
          <div class="form-row"><div class="form-group"><label>Total Experience <span class="required">*</span></label><div class="form-row" style="margin-top:6px"><div class="input-wrapper select-wrapper no-icon"><select id="expYears"><option value="">Years</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select><i class="fas fa-chevron-down select-arrow"></i></div><div class="input-wrapper select-wrapper no-icon"><select id="expMonths"><option value="">Months</option><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div></div></div>
          <div class="form-row"><div class="form-group"><label>Job Title <span class="required">*</span></label><div class="input-wrapper"><i class="fas fa-briefcase input-icon"></i><input type="text" id="jobTitle" placeholder="e.g., Sales Executive"></div></div><div class="form-group"><label>Company <span class="required">*</span></label><div class="input-wrapper"><i class="fas fa-building input-icon"></i><input type="text" id="company" placeholder="e.g., Flipkart"></div></div></div>
        </div>
        <div class="form-row" id="salarySection"><div class="form-group"><label>Current Salary (CTC) <span class="required">*</span></label><div class="input-wrapper"><i class="fas fa-rupee-sign input-icon"></i><input type="text" id="currentSalary" placeholder="e.g., 3,00,000"></div><p class="helper-text">Per annum</p></div><div class="form-group"><label>Expected Salary <span class="required">*</span></label><div class="input-wrapper"><i class="fas fa-rupee-sign input-icon"></i><input type="text" id="expectedSalary" placeholder="e.g., 4,50,000"></div></div></div>
        <div class="form-group"><label>Key Skills <span class="required">*</span></label><div class="skills-input-container"><div class="skills-tags" id="skillsTags"></div><input type="text" class="skills-input" id="skillsInput" placeholder="Type a skill and press Enter..."></div><p class="skills-counter"><span id="skillsCount">0</span>/10 skills</p></div>
        <div class="form-group"><label>About Me <span class="optional-label">(Optional)</span></label><div class="input-wrapper"><i class="fas fa-user-circle input-icon"></i><textarea id="aboutMe" placeholder="Tell employers about yourself, your work style, strengths, and career goals..." rows="4" maxlength="500" style="padding: 12px 12px 12px 40px; border: 1px solid #E5E7EB; border-radius: 8px; font-family: inherit; font-size: 14px; width: 100%; resize: vertical;"></textarea></div><p class="helper-text"><span id="aboutMeCount">0</span>/500 characters</p></div>
        <div class="form-group"><label>Upload Resume <span class="required">*</span></label><div class="file-upload-area" id="resumeUploadArea"><div class="file-upload-icon"><i class="fas fa-cloud-upload-alt"></i></div><p class="file-upload-text">Click or drag PDF/DOCX</p><input type="file" class="file-upload-input" id="resumeInput" accept=".pdf,.doc,.docx"></div><div class="uploaded-file" id="uploadedResume" style="display:none"><div class="uploaded-file-icon"><i class="fas fa-file-pdf"></i></div><div class="uploaded-file-info"><div class="uploaded-file-name" id="resumeFileName">resume.pdf</div><div class="uploaded-file-size" id="resumeFileSize">245 KB</div></div><button type="button" class="uploaded-file-remove" id="removeResume"><i class="fas fa-times"></i></button></div></div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" id="step2BackBtn">Back</button><button type="button" class="btn btn-primary" id="step2NextBtn">Continue</button></div>
      </div>`;
    }

    function getStep3HTML() {
      return `<div class="form-step" data-step="3">
        <div class="form-header"><h1>Education & Preferences</h1><p>Final step</p></div>
        <div class="form-row"><div class="form-group"><label>Qualification <span class="required">*</span></label><div class="input-wrapper select-wrapper"><i class="fas fa-graduation-cap input-icon"></i><select id="qualification" required><option value="" disabled selected>Select</option><option value="10th">10th</option><option value="12th">12th</option><option value="graduate">Graduate</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div><div class="form-group"><label>Course <span class="required">*</span></label><div class="input-wrapper select-wrapper"><i class="fas fa-book input-icon"></i><select id="course" required><option value="" disabled selected>Select</option><option value="btech">B.Tech</option><option value="bcom">B.Com</option><option value="other">Other</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div></div>
        <div class="form-row"><div class="form-group"><label>College <span class="required">*</span></label><div class="input-wrapper"><i class="fas fa-university input-icon"></i><input type="text" id="college" placeholder="Institution name" required></div></div><div class="form-group"><label>Passing Year <span class="required">*</span></label><div class="input-wrapper select-wrapper no-icon"><select id="passingYear" required><option value="" disabled selected>Select</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div></div>
        <div class="form-row"><div class="form-group"><label>Notice Period <span class="required">*</span></label><div class="input-wrapper select-wrapper"><i class="fas fa-calendar input-icon"></i><select id="noticePeriod" required><option value="" disabled selected>Select</option><option value="immediate">Immediate</option><option value="15-days">15 Days</option><option value="1-month">1 Month</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div><div class="form-group"><label>Work Type <span class="required">*</span></label><div class="input-wrapper select-wrapper"><i class="fas fa-briefcase input-icon"></i><select id="workType" required><option value="" disabled selected>Select</option><option value="office">Office</option><option value="remote">Remote</option><option value="hybrid">Hybrid</option></select><i class="fas fa-chevron-down select-arrow"></i></div></div></div>
        <div class="form-actions"><button type="button" class="btn btn-secondary" id="step3BackBtn">Back</button><button type="button" class="btn btn-primary" id="createAccountBtn">Create Profile</button></div>
      </div>`;
    }

    function getSuccessHTML() {
      return `<div class="form-step" id="successState"><div class="success-animation"><div class="success-checkmark"><div class="check-icon"><span class="icon-line line-tip"></span><span class="icon-line line-long"></span><div class="icon-circle"></div><div class="icon-fix"></div></div></div></div><h1 class="success-title">Profile Created!</h1><p class="success-message">Redirecting to dashboard...</p></div>`;
    }

    function initOtpHandlers() {
      const phoneInput = document.getElementById('phoneNumber');
      const sendOtpBtn = document.getElementById('sendOtpBtn');
      const otpInputs = document.querySelectorAll('.otp-input');

      // Real-time email validation
      setTimeout(() => {
        const emailInput = document.getElementById('email');
        const emailError = document.getElementById('emailError');
        emailInput.addEventListener('blur', () => {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(emailInput.value)) {
            emailError.style.display = 'flex';
            emailValid = false;
          } else {
            emailError.style.display = 'none';
            emailValid = true;
          }
        });

        // Real-time password validation
        const passwordInput = document.getElementById('password');
        const passwordError = document.getElementById('passwordError');
        passwordInput.addEventListener('input', () => {
          if (passwordInput.value.length < 6) {
            passwordError.style.display = 'flex';
            passwordValid = false;
          } else {
            passwordError.style.display = 'none';
            passwordValid = true;
          }
        });
      }, 500);

      sendOtpBtn.addEventListener('click', () => {
        const phone = phoneInput.value.trim();
        if (phone.length !== 10 || !/^\d+$/.test(phone)) {
          document.getElementById('phoneError').style.display = 'flex';
          return;
        }
        document.getElementById('phoneError').style.display = 'none';
        phoneNumber = phone;
        document.getElementById('phoneDisplay').textContent = '+91 ' + phone;
        document.getElementById('mobileSection').style.display = 'none';
        document.getElementById('otpSection').style.display = 'block';
        startResendTimer();
        otpInputs[0].focus();
      });

      otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/\D/g, '');
          if (e.target.value && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
          if (e.target.value) e.target.classList.add('filled');
          else e.target.classList.remove('filled');
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
          }
        });
      });

      document.getElementById('autoFillOtp').addEventListener('click', () => {
        '123456'.split('').forEach((digit, i) => {
          otpInputs[i].value = digit;
          otpInputs[i].classList.add('filled');
        });
      });

      document.getElementById('verifyOtpBtn').addEventListener('click', () => {
        const otp = Array.from(otpInputs).map(i => i.value).join('');
        if (otp.length < 6) {
          document.getElementById('otpError').style.display = 'flex';
          return;
        }
        document.getElementById('otpError').style.display = 'none';
        document.getElementById('otpSection').style.display = 'none';
        document.getElementById('detailsSection').style.display = 'block';
        setTimeout(() => {
          document.getElementById('fullName').focus();
        }, 100);
      });

      document.getElementById('resendOtp').addEventListener('click', () => { otpInputs.forEach(i => { i.value = ''; i.classList.remove('filled'); }); otpInputs[0].focus(); startResendTimer(); });

      setTimeout(() => {
        document.getElementById('togglePassword').addEventListener('click', () => {
          const p = document.getElementById('password');
          p.type = p.type === 'password' ? 'text' : 'password';
          document.querySelector('#togglePassword i').classList.toggle('fa-eye');
          document.querySelector('#togglePassword i').classList.toggle('fa-eye-slash');
        });

        document.getElementById('step1NextBtn').addEventListener('click', () => {
          const fullName = document.getElementById('fullName').value.trim();
          const email = document.getElementById('email').value.trim();
          const city = document.getElementById('city').value;
          const state = document.getElementById('state').value;
          const password = document.getElementById('password').value;
          const termsChecked = document.getElementById('termsCheck').checked;

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          const isEmailValid = emailRegex.test(email);
          const isPasswordValid = password.length >= 6;

          if (!fullName || !isEmailValid || !city || !state || !isPasswordValid || !termsChecked) {
            if (!fullName) alert('Please enter your full name');
            else if (!isEmailValid) alert('Please enter a valid email address');
            else if (!city) alert('Please select your city');
            else if (!state) alert('Please select your state');
            else if (!isPasswordValid) alert('Password must be at least 6 characters');
            else if (!termsChecked) alert('Please agree to the Terms of Service');
            return;
          }
          goToStep(2);
        });
      }, 500);
    }

    let resendTimerInterval;
    function startResendTimer() {
      let s = 30; const timer = document.getElementById('resendTimer'), btn = document.getElementById('resendOtp'); btn.disabled = true;
      resendTimerInterval = setInterval(() => { s--; timer.textContent = `(${s}s)`; if (s <= 0) { clearInterval(resendTimerInterval); timer.textContent = ''; btn.disabled = false; } }, 1000);
    }

    function initStep2Handlers() {
      document.querySelectorAll('.toggle-option').forEach(o => o.addEventListener('click', () => {
        document.querySelectorAll('.toggle-option').forEach(x => x.classList.remove('active')); o.classList.add('active');
        isExperienced = o.dataset.value === 'experienced';
        document.getElementById('experienceSection').style.display = isExperienced ? 'block' : 'none';
        document.getElementById('salarySection').style.display = isExperienced ? 'grid' : 'none';
      }));

      const skillsInput = document.getElementById('skillsInput');
      skillsInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addSkill(skillsInput.value); skillsInput.value = ''; } });

      // About Me character counter
      const aboutMeField = document.getElementById('aboutMe');
      const aboutMeCounter = document.getElementById('aboutMeCount');
      aboutMeField.addEventListener('input', () => {
        aboutMeCounter.textContent = aboutMeField.value.length;
      });

      const resumeArea = document.getElementById('resumeUploadArea'), resumeInput = document.getElementById('resumeInput');
      resumeArea.addEventListener('click', () => resumeInput.click());
      resumeInput.addEventListener('change', e => handleResume(e.target.files[0]));
      document.getElementById('removeResume').addEventListener('click', () => { resumeFile = null; resumeArea.classList.remove('has-file'); document.getElementById('uploadedResume').style.display = 'none'; resumeInput.value = ''; });

      document.getElementById('step2BackBtn').addEventListener('click', () => goToStep(1));
      document.getElementById('step2NextBtn').addEventListener('click', () => {
        if (skills.length < 1) { alert('Add at least one skill'); return; }
        if (!resumeFile) { alert('Upload your resume'); return; }
        if (isExperienced && (!document.getElementById('jobTitle').value.trim() || !document.getElementById('company').value.trim())) { alert('Fill job details'); return; }
        goToStep(3);
      });
    }

    function addSkill(s) { s = s.trim(); if (!s || skills.includes(s) || skills.length >= 10) return; skills.push(s); renderSkills(); }
    function removeSkill(s) { skills = skills.filter(x => x !== s); renderSkills(); }
    function renderSkills() { document.getElementById('skillsTags').innerHTML = skills.map(s => `<span class="skill-tag">${s}<button type="button" onclick="removeSkill('${s}')">&times;</button></span>`).join(''); document.getElementById('skillsCount').textContent = skills.length; }
    function handleResume(f) { if (!f) return; const valid = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']; if (!valid.includes(f.type) || f.size > 5 * 1024 * 1024) { alert('Invalid file'); return; } resumeFile = f; document.getElementById('resumeUploadArea').classList.add('has-file'); document.getElementById('resumeFileName').textContent = f.name; document.getElementById('resumeFileSize').textContent = (f.size / 1024).toFixed(0) + ' KB'; document.getElementById('uploadedResume').style.display = 'flex'; }

    function initStep3Handlers() {
      ['currentSalary', 'expectedSalary'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem) {
          elem.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '');
            if (v) v = parseInt(v).toLocaleString('en-IN');
            e.target.value = v;
          });
        }
      });

      document.getElementById('step3BackBtn').addEventListener('click', () => goToStep(2));

      // REAL SUPABASE SUBMISSION
      const btn = document.getElementById('createAccountBtn');

      btn.addEventListener('click', async function (e) {
        e.preventDefault();

        if (!document.getElementById('qualification').value || !document.getElementById('course').value || !document.getElementById('college').value.trim() || !document.getElementById('passingYear').value || !document.getElementById('noticePeriod').value || !document.getElementById('workType').value) {
          const qual = document.getElementById('qualification').value;
          const course = document.getElementById('course').value;
          const college = document.getElementById('college').value.trim();
          const passYear = document.getElementById('passingYear').value;
          const notice = document.getElementById('noticePeriod').value;
          const workType = document.getElementById('workType').value;

          console.log('Validation failed:', { qual, course, college, passYear, notice, workType });

          if (!qual) alert('Please select a Qualification');
          else if (!course) alert('Please select a Course');
          else if (!college) alert('Please enter your College name');
          else if (!passYear) alert('Please select a Passing Year');
          else if (!notice) alert('Please select a Notice Period');
          else if (!workType) alert('Please select a Work Type');
          return;
        }

        btn.disabled = true;
        btn.innerHTML = 'Creating...';

        try {
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          const fullName = document.getElementById('fullName').value.trim();
          const city = document.getElementById('city').value;
          const state = document.getElementById('state').value;

          let expYears = 0;
          let expMonths = 0;
          if (isExperienced) {
            const yearsValue = document.getElementById('expYears').value;
            const monthsValue = document.getElementById('expMonths').value;
            expYears = yearsValue ? parseInt(yearsValue) : 0;
            expMonths = monthsValue ? parseInt(monthsValue) : 0;
          }

          const currentSalaryText = isExperienced ? document.getElementById('currentSalary').value : null;
          const expectedSalaryText = isExperienced ? document.getElementById('expectedSalary').value : null;
          const currentSalary = currentSalaryText ? parseInt(currentSalaryText.replace(/,/g, '')) : null;
          const expectedSalary = expectedSalaryText ? parseInt(expectedSalaryText.replace(/,/g, '')) : null;

          // Get About Me (optional field)
          const aboutMe = document.getElementById('aboutMe').value.trim() || null;

          const qualification = document.getElementById('qualification').value;
          const course = document.getElementById('course').value;
          const college = document.getElementById('college').value.trim();
          const passingYear = document.getElementById('passingYear').value;
          const noticePeriod = document.getElementById('noticePeriod').value;
          const workType = document.getElementById('workType').value;

          console.log('Creating user with email:', email);

          const { data: authData, error: authError } = await sb.auth.signUp({
            email: email,
            password: password,
            options: {
              data: {
                full_name: fullName,
                phone: phoneNumber
              }
            }
          });

          console.log('Auth result:', authData, authError);

          if (authError) throw new Error(authError.message);
          if (!authData.user) throw new Error('Failed to create account');

          // Upload resume to Supabase Storage
          let resumeUrl = null;
          if (resumeFile) {
            console.log('Uploading resume...');
            const fileExt = resumeFile.name.split('.').pop();
            const fileName = `${authData.user.id}-${Date.now()}.${fileExt}`;
            
            const { data: uploadData, error: uploadError } = await sb.storage
              .from('resumes')
              .upload(fileName, resumeFile);
            
            if (uploadError) {
              console.error('Resume upload failed:', uploadError);
              // Don't fail signup if resume upload fails, just log it
            } else {
              // Get public URL for the uploaded resume
              const { data: urlData } = sb.storage
                .from('resumes')
                .getPublicUrl(fileName);
              resumeUrl = urlData.publicUrl;
              console.log('Resume uploaded:', resumeUrl);
            }
          }

          const { error: profileError } = await sb
            .from('candidates')
            .insert({
              user_id: authData.user.id,
              full_name: fullName,
              email: email,
              phone: phoneNumber,
              city: city,
              state: state,
              is_experienced: isExperienced,
              experience_years: expYears,
              experience_months: expMonths,
              skills: skills, // Array of skills
              current_salary: currentSalary,
              expected_salary: expectedSalary,
              about_me: aboutMe,
              qualification: qualification,
              course: course,
              college: college,
              passing_year: passingYear,
              notice_period: noticePeriod,
              work_type: workType,
              resume_url: resumeUrl
              // Note: profile_pic_url can be added later
            });

          if (profileError) throw new Error('Profile save failed: ' + profileError.message);

          console.log('SUCCESS!');
          document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
          document.getElementById('successState').classList.add('active');

          setTimeout(() => {
            window.location.href = 'candidate-dashboard.html';
          }, 2000);

        } catch (error) {
          console.error('Error:', error);
          btn.disabled = false;
          btn.innerHTML = 'Create Profile';
          alert('Error: ' + error.message);
        }
      });
    }
  </script>
</body>

</html>